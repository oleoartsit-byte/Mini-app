// Quest Wall æ•°æ®åº“ Schema
// åŸºäº questwall-db-design.md æ–‡æ¡£

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ç”¨æˆ·è¡¨ ====================
model User {
  id                BigInt    @id @default(autoincrement())
  tgId              BigInt    @unique @map("tg_id")
  username          String?
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  avatarUrl         String?   @map("avatar_url") // Telegram å¤´åƒ URL
  walletAddr        String?   @map("wallet_addr")
  locale            String    @default("en")
  riskScore         Int       @default(0) @map("risk_score")
  points            Int       @default(0) // ç”¨æˆ·ç§¯åˆ†ï¼ˆä»»åŠ¡å¥–åŠ± USDT * 10ï¼‰
  // Twitter ç»‘å®šä¿¡æ¯
  twitterId         String?   @unique @map("twitter_id") // Twitter ç”¨æˆ· ID
  twitterUsername   String?   @map("twitter_username") // Twitter ç”¨æˆ·å
  twitterBindAt     DateTime? @map("twitter_bind_at") // ç»‘å®šæ—¶é—´
  // é€šçŸ¥åå¥½è®¾ç½®
  notificationPrefs Json      @default("{\"questComplete\":true,\"reward\":true,\"newQuest\":true,\"checkIn\":true,\"invite\":true}") @map("notification_prefs")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // å…³ç³»
  ownedQuests Quest[]  @relation("QuestOwner")
  actions     Action[]
  rewards     Reward[]
  payouts     Payout[]

  @@map("users")
}

// ==================== ä»»åŠ¡è¡¨ ====================
model Quest {
  id              BigInt      @id @default(autoincrement())
  ownerId         BigInt      @map("owner_id")
  type            QuestType
  // å¤šè¯­è¨€æ”¯æŒ
  title           String // é»˜è®¤æ ‡é¢˜ï¼ˆä¸­æ–‡ï¼‰
  titleEn         String?     @map("title_en") // è‹±æ–‡æ ‡é¢˜
  description     String? // é»˜è®¤æè¿°ï¼ˆä¸­æ–‡ï¼‰
  descriptionEn   String?     @map("description_en") // è‹±æ–‡æè¿°
  rewardType      RewardType  @map("reward_type")
  rewardAmount    Decimal     @map("reward_amount") @db.Decimal(20, 8)
  rewardPoints    Int         @default(0) @map("reward_points") // ç§¯åˆ†å¥–åŠ±ï¼ˆé»˜è®¤ä¸º USDT * 10ï¼‰
  rewardAsset     String?     @map("reward_asset")
  limits          Json        @default("{}")
  status          QuestStatus @default(DRAFT)
  targetUrl       String?     @map("target_url")
  channelId       String?     @map("channel_id")
  targetCountries String[]    @default([]) @map("target_countries") // ç›®æ ‡å›½å®¶åˆ—è¡¨ï¼Œç©ºæ•°ç»„è¡¨ç¤ºå…¨çƒ
  stepDetails     Json?       @map("step_details") // ä»»åŠ¡æ­¥éª¤è¯¦æƒ…ï¼ˆæ”¯æŒå›¾ç‰‡ã€è§†é¢‘ï¼‰
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // å…³ç³»
  owner   User     @relation("QuestOwner", fields: [ownerId], references: [id])
  actions Action[]
  rewards Reward[]

  @@map("quests")
}

// ==================== ç”¨æˆ·è¡Œä¸ºè¡¨ ====================
model Action {
  id          BigInt       @id @default(autoincrement())
  userId      BigInt       @map("user_id")
  questId     BigInt       @map("quest_id")
  twitterId   String?      @map("twitter_id") // å®Œæˆ Twitter ä»»åŠ¡æ—¶ä½¿ç”¨çš„ Twitter IDï¼ˆç”¨äºé˜²æ­¢åŒä¸€ Twitter é‡å¤åšä»»åŠ¡ï¼‰
  proof       Json?
  proofImage  String?      @map("proof_image") // ä»»åŠ¡å®Œæˆæˆªå›¾ï¼ˆç”¨äºäººå·¥å®¡æ ¸ï¼‰
  riskScore   Int          @default(0) @map("risk_score")
  status      ActionStatus @default(CLAIMED)
  claimedAt   DateTime     @default(now()) @map("claimed_at")
  submittedAt DateTime?    @map("submitted_at")
  verifiedAt  DateTime?    @map("verified_at")
  createdAt   DateTime     @default(now()) @map("created_at")

  // å…³ç³»
  user   User    @relation(fields: [userId], references: [id])
  quest  Quest   @relation(fields: [questId], references: [id])
  reward Reward?

  @@unique([userId, questId])
  @@index([twitterId, questId]) // ç´¢å¼•ï¼šç”¨äºå¿«é€ŸæŸ¥è¯¢æŸ Twitter æ˜¯å¦å·²å®ŒæˆæŸä»»åŠ¡
  @@map("actions")
}

// ==================== å¥–åŠ±è¡¨ ====================
model Reward {
  id        BigInt       @id @default(autoincrement())
  userId    BigInt       @map("user_id")
  questId   BigInt       @map("quest_id")
  actionId  BigInt       @unique @map("action_id")
  type      RewardType
  amount    Decimal      @db.Decimal(20, 8)
  asset     String?
  txHash    String?      @map("tx_hash")
  starsTxId String?      @map("stars_tx_id")
  status    RewardStatus @default(PENDING)
  createdAt DateTime     @default(now()) @map("created_at")

  // å…³ç³»
  user   User   @relation(fields: [userId], references: [id])
  quest  Quest  @relation(fields: [questId], references: [id])
  action Action @relation(fields: [actionId], references: [id])

  @@map("rewards")
}

// ==================== æç°è¡¨ ====================
model Payout {
  id            BigInt       @id @default(autoincrement())
  beneficiaryId BigInt       @map("beneficiary_id")
  asset         String
  amount        Decimal      @db.Decimal(20, 8)
  toAddress     String       @map("to_address")
  status        PayoutStatus @default(PENDING)
  txHash        String?      @map("tx_hash")
  proofImage    String?      @map("proof_image") // è½¬è´¦å‡­è¯æˆªå›¾
  createdAt     DateTime     @default(now()) @map("created_at")
  processedAt   DateTime?    @map("processed_at")

  // å…³ç³»
  beneficiary User @relation(fields: [beneficiaryId], references: [id])

  @@map("payouts")
}

// ==================== Twitter ç»‘å®šå†å²è¡¨ ====================
// è®°å½•æ‰€æœ‰ç»‘å®šè¿‡çš„ Twitter è´¦å·ï¼Œç”¨äºé˜²æ­¢åŒä¸€ Twitter è¢«å¤šä¸ª TG è´¦å·ç»‘å®š
model TwitterBindHistory {
  id              BigInt   @id @default(autoincrement())
  twitterId       String   @map("twitter_id") // Twitter ç”¨æˆ· ID
  twitterUsername String?  @map("twitter_username") // Twitter ç”¨æˆ·åï¼ˆè®°å½•æ—¶çš„ï¼‰
  ownerTgId       BigInt   @map("owner_tg_id") // é¦–æ¬¡ç»‘å®šçš„ TG ç”¨æˆ· IDï¼ˆæ°¸ä¹…å½’å±ï¼‰
  bindCount       Int      @default(1) @map("bind_count") // ç»‘å®šæ¬¡æ•°
  firstBindAt     DateTime @default(now()) @map("first_bind_at")
  lastBindAt      DateTime @default(now()) @map("last_bind_at")

  @@unique([twitterId])
  @@index([ownerTgId])
  @@map("twitter_bind_history")
}

// ==================== ç­¾åˆ°è¡¨ ====================
model CheckIn {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt   @map("user_id")
  day       Int
  points    Int      @default(0)
  checkedAt DateTime @default(now()) @map("checked_at")

  @@unique([userId, day])
  @@map("check_ins")
}

// ==================== é‚€è¯·è®°å½•è¡¨ ====================
model Invite {
  id           BigInt   @id @default(autoincrement())
  inviterId    BigInt   @map("inviter_id")
  inviteeId    BigInt   @unique @map("invitee_id")
  bonus        Decimal  @default(0) @db.Decimal(20, 8) // é‚€è¯·äººå¥–åŠ±
  inviteeBonus Decimal  @default(0) @map("invitee_bonus") @db.Decimal(20, 8) // è¢«é‚€è¯·äººå¥–åŠ±
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("invites")
}

// ==================== æ•™ç¨‹è¡¨ ====================
model Tutorial {
  id            BigInt         @id @default(autoincrement())
  type          TutorialType   @default(ARTICLE) // æ•™ç¨‹ç±»å‹ï¼šæ–‡ç« ã€è§†é¢‘ã€å›¾æ–‡
  category      String         @default("other") // åˆ†ç±»ï¼štelegram, twitter, wallet, invite, other
  // å¤šè¯­è¨€æ”¯æŒ
  title         String // é»˜è®¤æ ‡é¢˜ï¼ˆä¸­æ–‡ï¼‰
  titleEn       String?        @map("title_en") // è‹±æ–‡æ ‡é¢˜
  description   String? // é»˜è®¤æè¿°ï¼ˆä¸­æ–‡ï¼‰
  descriptionEn String?        @map("description_en") // è‹±æ–‡æè¿°
  content       String?        @db.Text // é»˜è®¤å†…å®¹ï¼ˆä¸­æ–‡ï¼‰- å¯Œæ–‡æœ¬/Markdown
  contentEn     String?        @map("content_en") @db.Text // è‹±æ–‡å†…å®¹
  // åª’ä½“èµ„æº
  coverImage    String?        @map("cover_image") // å°é¢å›¾ç‰‡ URL
  videoUrl      String?        @map("video_url") // è§†é¢‘ URLï¼ˆYouTube/æœ¬åœ°ï¼‰
  images        String[]       @default([]) // å›¾ç‰‡åˆ—è¡¨ï¼ˆå›¾æ–‡æ•™ç¨‹ç”¨ï¼‰
  // å…ƒæ•°æ®
  icon          String         @default("ğŸ“–") // æ˜¾ç¤ºå›¾æ ‡
  sortOrder     Int            @default(0) @map("sort_order") // æ’åºæƒé‡
  viewCount     Int            @default(0) @map("view_count") // æµè§ˆæ¬¡æ•°
  status        TutorialStatus @default(DRAFT)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@map("tutorials")
}

enum TutorialType {
  ARTICLE // æ–‡ç« æ•™ç¨‹
  VIDEO // è§†é¢‘æ•™ç¨‹
  IMAGE_TEXT // å›¾æ–‡æ•™ç¨‹
}

enum TutorialStatus {
  DRAFT // è‰ç¨¿
  PUBLISHED // å·²å‘å¸ƒ
  ARCHIVED // å·²å½’æ¡£
}

// ==================== ç®¡ç†å‘˜è¡¨ ====================
model Admin {
  id          BigInt    @id @default(autoincrement())
  username    String    @unique
  password    String // bcrypt åŠ å¯†
  role        String    @default("admin") // admin, super_admin
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("admins")
}

// ==================== ç³»ç»Ÿé…ç½®è¡¨ ====================
model SystemConfig {
  id          BigInt   @id @default(autoincrement())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// ==================== è®¾å¤‡æŒ‡çº¹è¡¨ ====================
model DeviceFingerprint {
  id          BigInt   @id @default(autoincrement())
  visitorId   String   @map("visitor_id") // è®¾å¤‡å”¯ä¸€æ ‡è¯†
  userId      BigInt?  @map("user_id")
  userAgent   String?  @map("user_agent")
  platform    String?
  screenRes   String?  @map("screen_res")
  timezone    String?
  language    String?
  fingerprint Json? // å®Œæ•´æŒ‡çº¹æ•°æ®
  firstSeenAt DateTime @default(now()) @map("first_seen_at")
  lastSeenAt  DateTime @default(now()) @map("last_seen_at")

  @@unique([visitorId, userId])
  @@map("device_fingerprints")
}

// ==================== IP è®°å½•è¡¨ ====================
model IpRecord {
  id           BigInt   @id @default(autoincrement())
  ip           String
  userId       BigInt?  @map("user_id")
  country      String?
  city         String?
  isp          String?
  isVpn        Boolean  @default(false) @map("is_vpn")
  isProxy      Boolean  @default(false) @map("is_proxy")
  requestCount Int      @default(1) @map("request_count")
  firstSeenAt  DateTime @default(now()) @map("first_seen_at")
  lastSeenAt   DateTime @default(now()) @map("last_seen_at")

  @@unique([ip, userId])
  @@index([ip])
  @@map("ip_records")
}

// ==================== é»‘åå•è¡¨ ====================
model Blacklist {
  id        BigInt        @id @default(autoincrement())
  type      BlacklistType
  value     String // å¯ä»¥æ˜¯ userId, visitorId, ip
  reason    String?
  expiresAt DateTime?     @map("expires_at") // null è¡¨ç¤ºæ°¸ä¹…
  createdAt DateTime      @default(now()) @map("created_at")

  @@unique([type, value])
  @@map("blacklists")
}

// ==================== é£æ§äº‹ä»¶æ—¥å¿— ====================
model RiskEvent {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt?  @map("user_id")
  eventType String   @map("event_type") // rate_limit, suspicious_device, etc.
  severity  String // low, medium, high, critical
  details   Json?
  ip        String?
  visitorId String?  @map("visitor_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([eventType])
  @@map("risk_events")
}

enum BlacklistType {
  USER // ç”¨æˆ·é»‘åå•
  DEVICE // è®¾å¤‡é»‘åå•
  IP // IP é»‘åå•
}

// ==================== æšä¸¾ç±»å‹ ====================

enum QuestType {
  JOIN_CHANNEL // å…³æ³¨é¢‘é“
  JOIN_GROUP // åŠ å…¥ç¾¤ç»„
  DEEP_LINK // æ·±åº¦é“¾æ¥
  ONCHAIN_TRANSFER // é“¾ä¸Šè½¬è´¦
  MINT_NFT // é“¸é€  NFT
  FORM // è¡¨å•ä»»åŠ¡
  FOLLOW_TWITTER // å…³æ³¨æ¨ç‰¹
  RETWEET_TWITTER // è½¬å‘æ¨ç‰¹
  LIKE_TWITTER // ç‚¹èµæ¨ç‰¹
  COMMENT_TWITTER // è¯„è®ºæ¨ç‰¹
  LIKE_POST // ç‚¹èµå¸–å­
  CUSTOM // è‡ªå®šä¹‰ä»»åŠ¡
}

enum RewardType {
  STARS // Telegram Stars
  JETTON // TON Jetton
  NFT // NFT
  POINTS // ç§¯åˆ†
  USDT // USDT
  TON // TON
}

enum QuestStatus {
  DRAFT // è‰ç¨¿
  ACTIVE // æ´»è·ƒ
  PAUSED // æš‚åœ
  ENDED // ç»“æŸ
}

enum ActionStatus {
  CLAIMED // å·²é¢†å–
  SUBMITTED // å·²æäº¤
  VERIFIED // å·²éªŒè¯
  REJECTED // å·²æ‹’ç»
  REWARDED // å·²å‘å¥–
}

enum RewardStatus {
  PENDING // å¾…å‘æ”¾
  PROCESSING // å¤„ç†ä¸­
  COMPLETED // å·²å®Œæˆ
  FAILED // å¤±è´¥
}

enum PayoutStatus {
  PENDING // å¾…å¤„ç†
  PROCESSING // å¤„ç†ä¸­
  COMPLETED // å·²å®Œæˆ
  FAILED // å¤±è´¥
}
