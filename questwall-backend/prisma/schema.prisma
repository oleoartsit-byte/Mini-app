// Quest Wall 数据库 Schema
// 基于 questwall-db-design.md 文档

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 用户表 ====================
model User {
  id          BigInt    @id @default(autoincrement())
  tgId        BigInt    @unique @map("tg_id")
  username    String?
  firstName   String?   @map("first_name")
  lastName    String?   @map("last_name")
  avatarUrl   String?   @map("avatar_url")  // Telegram 头像 URL
  walletAddr  String?   @map("wallet_addr")
  locale      String    @default("en")
  riskScore   Int       @default(0) @map("risk_score")
  // Twitter 绑定信息
  twitterId       String?   @unique @map("twitter_id")       // Twitter 用户 ID
  twitterUsername String?   @map("twitter_username") // Twitter 用户名
  twitterBindAt   DateTime? @map("twitter_bind_at")  // 绑定时间
  // 通知偏好设置
  notificationPrefs Json @default("{\"questComplete\":true,\"reward\":true,\"newQuest\":true,\"checkIn\":true,\"invite\":true}") @map("notification_prefs")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // 关系
  ownedQuests Quest[]   @relation("QuestOwner")
  actions     Action[]
  rewards     Reward[]
  payouts     Payout[]

  @@map("users")
}

// ==================== 任务表 ====================
model Quest {
  id            BigInt    @id @default(autoincrement())
  ownerId       BigInt    @map("owner_id")
  type          QuestType
  // 多语言支持
  title         String                    // 默认标题（中文）
  titleEn       String?   @map("title_en") // 英文标题
  description   String?                   // 默认描述（中文）
  descriptionEn String?   @map("description_en") // 英文描述
  rewardType    RewardType @map("reward_type")
  rewardAmount  Decimal   @map("reward_amount") @db.Decimal(20, 8)
  rewardAsset   String?   @map("reward_asset")
  limits        Json      @default("{}")
  status        QuestStatus @default(DRAFT)
  targetUrl     String?   @map("target_url")
  channelId     String?   @map("channel_id")
  targetCountries String[]  @default([]) @map("target_countries") // 目标国家列表，空数组表示全球
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // 关系
  owner         User      @relation("QuestOwner", fields: [ownerId], references: [id])
  actions       Action[]
  rewards       Reward[]

  @@map("quests")
}

// ==================== 用户行为表 ====================
model Action {
  id          BigInt       @id @default(autoincrement())
  userId      BigInt       @map("user_id")
  questId     BigInt       @map("quest_id")
  twitterId   String?      @map("twitter_id")  // 完成 Twitter 任务时使用的 Twitter ID（用于防止同一 Twitter 重复做任务）
  proof       Json?
  riskScore   Int          @default(0) @map("risk_score")
  status      ActionStatus @default(CLAIMED)
  claimedAt   DateTime     @default(now()) @map("claimed_at")
  submittedAt DateTime?    @map("submitted_at")
  verifiedAt  DateTime?    @map("verified_at")
  createdAt   DateTime     @default(now()) @map("created_at")

  // 关系
  user        User         @relation(fields: [userId], references: [id])
  quest       Quest        @relation(fields: [questId], references: [id])
  reward      Reward?

  @@unique([userId, questId])
  @@index([twitterId, questId])  // 索引：用于快速查询某 Twitter 是否已完成某任务
  @@map("actions")
}

// ==================== 奖励表 ====================
model Reward {
  id          BigInt      @id @default(autoincrement())
  userId      BigInt      @map("user_id")
  questId     BigInt      @map("quest_id")
  actionId    BigInt      @unique @map("action_id")
  type        RewardType
  amount      Decimal     @db.Decimal(20, 8)
  asset       String?
  txHash      String?     @map("tx_hash")
  starsTxId   String?     @map("stars_tx_id")
  status      RewardStatus @default(PENDING)
  createdAt   DateTime    @default(now()) @map("created_at")

  // 关系
  user        User        @relation(fields: [userId], references: [id])
  quest       Quest       @relation(fields: [questId], references: [id])
  action      Action      @relation(fields: [actionId], references: [id])

  @@map("rewards")
}

// ==================== 提现表 ====================
model Payout {
  id            BigInt       @id @default(autoincrement())
  beneficiaryId BigInt       @map("beneficiary_id")
  asset         String
  amount        Decimal      @db.Decimal(20, 8)
  toAddress     String       @map("to_address")
  status        PayoutStatus @default(PENDING)
  txHash        String?      @map("tx_hash")
  proofImage    String?      @map("proof_image")  // 转账凭证截图
  createdAt     DateTime     @default(now()) @map("created_at")
  processedAt   DateTime?    @map("processed_at")

  // 关系
  beneficiary   User         @relation(fields: [beneficiaryId], references: [id])

  @@map("payouts")
}

// ==================== Twitter 绑定历史表 ====================
// 记录所有绑定过的 Twitter 账号，用于防止同一 Twitter 被多个 TG 账号绑定
model TwitterBindHistory {
  id            BigInt    @id @default(autoincrement())
  twitterId     String    @map("twitter_id")      // Twitter 用户 ID
  twitterUsername String? @map("twitter_username") // Twitter 用户名（记录时的）
  ownerTgId     BigInt    @map("owner_tg_id")     // 首次绑定的 TG 用户 ID（永久归属）
  bindCount     Int       @default(1) @map("bind_count") // 绑定次数
  firstBindAt   DateTime  @default(now()) @map("first_bind_at")
  lastBindAt    DateTime  @default(now()) @map("last_bind_at")

  @@unique([twitterId])
  @@index([ownerTgId])
  @@map("twitter_bind_history")
}

// ==================== 签到表 ====================
model CheckIn {
  id          BigInt    @id @default(autoincrement())
  userId      BigInt    @map("user_id")
  day         Int
  points      Int       @default(0)
  checkedAt   DateTime  @default(now()) @map("checked_at")

  @@unique([userId, day])
  @@map("check_ins")
}

// ==================== 邀请记录表 ====================
model Invite {
  id           BigInt    @id @default(autoincrement())
  inviterId    BigInt    @map("inviter_id")
  inviteeId    BigInt    @unique @map("invitee_id")
  bonus        Decimal   @default(0) @db.Decimal(20, 8)        // 邀请人奖励
  inviteeBonus Decimal   @default(0) @db.Decimal(20, 8) @map("invitee_bonus") // 被邀请人奖励
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("invites")
}

// ==================== 管理员表 ====================
model Admin {
  id          BigInt    @id @default(autoincrement())
  username    String    @unique
  password    String    // bcrypt 加密
  role        String    @default("admin") // admin, super_admin
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("admins")
}

// ==================== 系统配置表 ====================
model SystemConfig {
  id          BigInt    @id @default(autoincrement())
  key         String    @unique
  value       Json
  description String?
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("system_configs")
}

// ==================== 设备指纹表 ====================
model DeviceFingerprint {
  id            BigInt    @id @default(autoincrement())
  visitorId     String    @map("visitor_id")  // 设备唯一标识
  userId        BigInt?   @map("user_id")
  userAgent     String?   @map("user_agent")
  platform      String?
  screenRes     String?   @map("screen_res")
  timezone      String?
  language      String?
  fingerprint   Json?     // 完整指纹数据
  firstSeenAt   DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt    DateTime  @default(now()) @map("last_seen_at")

  @@unique([visitorId, userId])
  @@map("device_fingerprints")
}

// ==================== IP 记录表 ====================
model IpRecord {
  id          BigInt    @id @default(autoincrement())
  ip          String
  userId      BigInt?   @map("user_id")
  country     String?
  city        String?
  isp         String?
  isVpn       Boolean   @default(false) @map("is_vpn")
  isProxy     Boolean   @default(false) @map("is_proxy")
  requestCount Int      @default(1) @map("request_count")
  firstSeenAt DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt  DateTime  @default(now()) @map("last_seen_at")

  @@unique([ip, userId])
  @@index([ip])
  @@map("ip_records")
}

// ==================== 黑名单表 ====================
model Blacklist {
  id          BigInt        @id @default(autoincrement())
  type        BlacklistType
  value       String        // 可以是 userId, visitorId, ip
  reason      String?
  expiresAt   DateTime?     @map("expires_at")  // null 表示永久
  createdAt   DateTime      @default(now()) @map("created_at")

  @@unique([type, value])
  @@map("blacklists")
}

// ==================== 风控事件日志 ====================
model RiskEvent {
  id          BigInt    @id @default(autoincrement())
  userId      BigInt?   @map("user_id")
  eventType   String    @map("event_type")  // rate_limit, suspicious_device, etc.
  severity    String    // low, medium, high, critical
  details     Json?
  ip          String?
  visitorId   String?   @map("visitor_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([eventType])
  @@map("risk_events")
}

enum BlacklistType {
  USER        // 用户黑名单
  DEVICE      // 设备黑名单
  IP          // IP 黑名单
}

// ==================== 枚举类型 ====================

enum QuestType {
  JOIN_CHANNEL    // 关注频道
  JOIN_GROUP      // 加入群组
  DEEP_LINK       // 深度链接
  ONCHAIN_TRANSFER // 链上转账
  MINT_NFT        // 铸造 NFT
  FORM            // 表单任务
  FOLLOW_TWITTER  // 关注推特
  RETWEET_TWITTER // 转发推特
  LIKE_TWITTER    // 点赞推特
  COMMENT_TWITTER // 评论推特
  LIKE_POST       // 点赞帖子
  CUSTOM          // 自定义任务
}

enum RewardType {
  STARS           // Telegram Stars
  JETTON          // TON Jetton
  NFT             // NFT
  POINTS          // 积分
  USDT            // USDT
  TON             // TON
}

enum QuestStatus {
  DRAFT           // 草稿
  ACTIVE          // 活跃
  PAUSED          // 暂停
  ENDED           // 结束
}

enum ActionStatus {
  CLAIMED         // 已领取
  SUBMITTED       // 已提交
  VERIFIED        // 已验证
  REJECTED        // 已拒绝
  REWARDED        // 已发奖
}

enum RewardStatus {
  PENDING         // 待发放
  PROCESSING      // 处理中
  COMPLETED       // 已完成
  FAILED          // 失败
}

enum PayoutStatus {
  PENDING         // 待处理
  PROCESSING      // 处理中
  COMPLETED       // 已完成
  FAILED          // 失败
}
